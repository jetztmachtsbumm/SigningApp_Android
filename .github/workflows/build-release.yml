name: Build & Release Signed APK

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > ${{ github.workspace }}/signing-key.jks
          echo "âœ“ Keystore decoded successfully"
          ls -lh ${{ github.workspace }}/signing-key.jks

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Debug Signing Configuration
        run: |
          echo "=== Checking Signing Setup ==="
          echo "Keystore file exists: $(test -f ${{ github.workspace }}/signing-key.jks && echo 'YES' || echo 'NO')"
          echo "Keystore size: $(ls -lh ${{ github.workspace }}/signing-key.jks 2>/dev/null || echo 'File not found')"
          echo "KEYSTORE_FILE is set: $(test -n "$KEYSTORE_FILE" && echo 'YES' || echo 'NO')"
          echo "KEY_ALIAS is set: $(test -n "$KEY_ALIAS" && echo 'YES' || echo 'NO')"
          echo "Passwords are set: $(test -n "$KEYSTORE_PASSWORD" && test -n "$KEY_PASSWORD" && echo 'YES' || echo 'NO')"
        env:
          KEYSTORE_FILE: ${{ github.workspace }}/signing-key.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Build Signed Release APK
        run: ./gradlew assembleRelease --stacktrace --info
        env:
          KEYSTORE_FILE: ${{ github.workspace }}/signing-key.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Verify APK is Signed
        run: |
          echo "=== Checking APK Signature ==="
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          echo "APK Location: $APK_PATH"
          echo "APK Size: $(ls -lh $APK_PATH | awk '{print $5}')"
          echo ""
          echo "=== META-INF Contents ==="
          unzip -l "$APK_PATH" | grep "META-INF/" || echo "No META-INF found!"
          echo ""
          if unzip -l "$APK_PATH" | grep -q "META-INF/CERT"; then
            echo "âœ“âœ“âœ“ APK is SIGNED! âœ“âœ“âœ“"
            echo ""
            echo "=== Certificate Details ==="
            unzip -p "$APK_PATH" META-INF/CERT.RSA | keytool -printcert | head -20
          else
            echo "âœ—âœ—âœ— APK is NOT signed! âœ—âœ—âœ—"
            exit 1
          fi

      - name: Calculate APK Checksum
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          echo "=== APK Checksum for provisioning.json ==="
          CHECKSUM=$(openssl dgst -binary -sha256 "$APK_PATH" | openssl base64)
          echo "Checksum: $CHECKSUM"
          echo ""
          echo "ðŸ“‹ Update your provisioning.json with:"
          echo "\"android.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_CHECKSUM\": \"$CHECKSUM\""

      - name: Upload Signed APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: app/build/outputs/apk/release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}